{% extends "foodcateringtem/frontend.html" %}
{% load static %}

{% block maincontent %}

<section class="py-16 bg-slate-100">
  <div class="max-w-7xl mx-auto px-6">

    <!-- TITLE -->
    <div class="text-center mb-14">
      <p class="text-sm tracking-widest text-emerald-600 font-semibold uppercase mb-2">
        Freshly Crafted
      </p>
      <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900">
        Our <span class="text-emerald-600">Menu</span>
      </h1>
      <div class="mt-4 flex justify-center">
        <span class="w-16 h-1 bg-emerald-600 rounded-full"></span>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-10">

      <!-- IMAGE COLUMN -->
      <div class="lg:col-span-1">
        <div class="sticky top-24 rounded-xl overflow-hidden border border-slate-200 bg-white">
          <img src="{% static 'bg-img.jpg' %}" alt="Catering"
               class="w-full h-96 object-cover">
          <div class="p-4 text-center text-sm font-medium text-slate-700">
            Fresh • Hygienic • Delicious
          </div>
        </div>
      </div>

      <!-- MENU COLUMN -->
      <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8">

        {% for category in categories %}
        <form method="POST" action="{% url 'party' %}">
          {% csrf_token %}

          <!-- CARD -->
          <div class="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition flex flex-col h-full">

            <!-- HEADER -->
            <div class="px-6 py-5 bg-slate-50 border-b border-slate-200 text-center rounded-t-xl">
              <h2 class="text-lg font-semibold text-slate-800">
                {{ category.name }}
              </h2>
              <p class="text-sm font-medium text-emerald-600 mt-1">
                Rs. {{ category.price_info }}
              </p>
            </div>

            <!-- ITEMS -->
            <div class="px-6 py-6 space-y-4 flex-grow">

              {% for dish in category.dishes.all %}
                {% if not dish.subitems.all %}
                  <label class="flex items-center gap-3 text-sm font-medium text-slate-700">
                    <input type="checkbox"
                           name="dishes_{{ category.id }}"
                           value="{{ dish.id }}"
                           class="accent-emerald-600 scale-110">
                    {{ dish.name }}
                  </label>
                {% else %}
                  <p class="text-sm font-semibold text-slate-800">
                    {{ dish.name }}
                  </p>
                  <div class="ml-4 space-y-2 bg-slate-50 p-3 rounded-md border border-slate-200">
                    {% for sub in dish.subitems.all %}
                    <label class="flex items-center gap-3 text-sm text-slate-600">
                      <input type="checkbox"
                             name="dish_{{ dish.id }}"
                             value="{{ sub.id }}"
                             class="accent-emerald-600 scale-110">
                      {{ sub.name }}
                    </label>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endfor %}

            </div>

            <!-- FOOTER -->
            <div class="px-6 py-5 border-t border-slate-200 bg-slate-50 rounded-b-xl">

              {% if not request.user.is_authenticated %}
              <p class="text-sm text-slate-600 text-center mb-3">
                Please <a href="{% url 'login' %}" class="underline">log in</a> to place an order.
              </p>
              {% endif %}

              <!-- DELIVERY ADDRESS -->
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Delivery Address
              </label>

              <div class="flex gap-2 mb-3">
                <input type="text"
                       name="delivery_address"
                       id="address_{{ category.id }}"
                       required
                       placeholder="Enter delivery address"
                       class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-emerald-600">

                <button type="button"
                        onclick="getLocation('{{ category.id }}')"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 rounded-md text-sm font-medium transition">
                  Use Location
                </button>
              </div>

              <!-- HIDDEN GEO -->
              <input type="hidden" id="lat_{{ category.id }}" name="latitude">
              <input type="hidden" id="lng_{{ category.id }}" name="longitude">

              <!-- EVENT DATE -->
              <label class="block text-sm font-medium text-slate-700 mb-1">
                Event Date
              </label>
              <input type="date"
                     name="event_date"
                     id="event_date"
                     required
                     class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm mb-4 focus:outline-none focus:ring-1 focus:ring-emerald-600">
              
              

              <!-- BUTTONS -->
              <button type="submit"
                      name="category_id"
                      value="{{ category.id }}"
                      {% if not request.user.is_authenticated %}disabled{% endif %}
                      class="w-full bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-md text-sm font-semibold transition disabled:opacity-40">
                Confirm Selection
              </button>

              {% comment %} <input type="hidden" name="payment_method" value="esewa"> {% endcomment %}

              <a href="{% url 'esewa' category.price_info category.id %}"
                class="w-full block text-center bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-md text-sm font-semibold mt-2">
                Pay Advance with eSewa
              </a>

              <p class="text-xs text-slate-500 text-center mt-2">
                You will be redirected to eSewa
              </p>

            </div>
          </div>
        </form>
        {% endfor %}

      </div>
    </div>
  </div>
</section>

<!-- GEOLOCATION SCRIPT (WORKING) -->
<script>
function getLocation(id) {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function (position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      document.getElementById(`lat_${id}`).value = lat;
      document.getElementById(`lng_${id}`).value = lng;
      document.getElementById(`address_${id}`).value =
        `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;
    },
    function () {
      alert("Location access denied");
    }
  );
}

    const d = new Date();
    d.setDate(d.getDate() + 2);  
    document.getElementById("event_date").min =
    d.toISOString().split('T')[0];

</script>

{% endblock %}
